<!doctype html>
<html lang='ja'>
<head>
<meta charset="utf-8">
<meta name="referrer" content="none">
<title>てくてくノート ver 2025-05-17</title>
<link href='./tools/bootstrap-5.3.0/css/bootstrap.min.css' rel='stylesheet'>
<link rel='icon' href='./tekuteku.ico'>
<meta name='viewport' content='width=device-width,initial-scale=1,shrink-to-fit=no'>
<style>.teku { background-size: auto; background-repeat: no-repeat; }</style>
</head>
<body>
<div class="container-fluid">
<div class="row">
<div class="col col-10">
	<div id="host" class="w-100 px-3 py-2 m-2 rounded-2 text-truncate fs-taker"></div>
	<div class="bg-dark" style="display:none;" id="whiteboard-exclude"></div>
	<div class="input-group m-2 align-items-start bg-dark" style="overflow-y:auto;height:40vh;" id="whiteboard-div">
		<table class="table table-sm table-dark table-borderless align-left m-2" id="whiteboard-table" style="table-layout:fixed;word-wrap:break-word;overflow-wrap:break-word;"></table>
	</div>
	<table class="table table-sm table-bordered align-middle m-2 bg-secondary text-white fs-taker" id="table-takers"><tbody></tbody></table>
	<div class="input-group m-2 taker"><textarea id="my-text" class="form-control fs-taker" rows="1" style="resize:none;" placeholder="ここでテキスト入力。'ENTER'で送信。'SHIFT+ENTER'で改行。'ESC'で全消去。"></textarea></div>
	<div class="input-group m-2 taker-extra"><textarea id="pre-roll" class="form-control fs-taker" style="overflow:auto;height:10vh;resize:vertical;" placeholder="'F1'でカーソル行を送信。ダブルクリックで入力欄にコピー。'ESC'で全消去。"></textarea></div>
</div>
<div class="col col-2 taker-extra">
	<div class="input-group m-2"><span class="input-group-text">F1</span><input type="text" id="key-1" class="form-control" value=""/></div>
	<div class="input-group m-2"><span class="input-group-text">F2</span><input type="text" id="key-2" class="form-control" value=""/></div>
	<div class="input-group m-2"><span class="input-group-text">F3</span><input type="text" id="key-3" class="form-control" value=""/></div>
	<div class="input-group m-2"><span class="input-group-text">F4</span><input type="text" id="key-4" class="form-control" value=""/></div>
	<div class="input-group m-2"><span class="input-group-text">F5</span><input type="text" id="key-5" class="form-control" value=""/></div>
	<div class="input-group m-2"><span class="input-group-text">F6</span><input type="text" id="key-6" class="form-control" value=""/></div>
	<div class="input-group m-2"><span class="input-group-text">F7</span><input type="text" id="key-7" class="form-control" value=""/></div>
	<div class="input-group m-2"><span class="input-group-text">F8</span><input type="text" id="key-8" class="form-control" value=""/></div>
	<div class="input-group m-2"><span class="input-group-text">F9</span><input type="text" id="key-9" class="form-control" value=""/></div>
	<div class="input-group m-2">
		<div class="dropdown" id="shortcut">
			<button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">短縮キー</button>
			<ul class="dropdown-menu">
			<li class="dropdown-item" data-job="load">読込</li>
			<li class="dropdown-item" data-job="save">保存</li>
			</ul>
			<input type="file" class="form-control" id="shortcut-load-file" style="display:none;" />
		</div>
	</div>
	<div class="input-group m-2 pt-5"><button class="btn btn-outline-warning" id="clear">テイクをクリア</button></div>
	<div id="pi-control" class="m-2 pt-auto">
		<a class="btn btn-outline-info" href="./pi.html" target="_blank">ラズパイ確認</a>
	</div>
</div>
</div>
<div class="row">
<div class="input-group">
	<div class="btn-group m-2 taker"><input type="text" id="taker-name" class="form-control px-1 text-center" placeholder="名札" maxlength="5" size="7" value=""/></div>
	<div class="btn-group m-2 taker-voice-recognition">
		<button class="btn btn-outline-success text-nowrap" id="recognition-control" value="0" disabled>音声認識開始</button>
		<div class="dropdown" id="recognition-engine">
			<button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" value="none">ブラウザ標準</button>
			<ul class="dropdown-menu">
			<li class="dropdown-item text-bg-primary" data-engine="default">ブラウザ標準</li>
			</ul>
		</div>
		<div class="dropdown" id="recognition-lang">
			<button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" value="none">日本語</button>
			<ul class="dropdown-menu">
			<li class="dropdown-item text-bg-primary" data-lang="ja-JP">日本語</li>
			<li class="dropdown-item" data-lang="en">英語</li>
			<li class="dropdown-item" data-lang="de">ドイツ語</li>
			<li class="dropdown-item" data-lang="zh">中国語</li>
			</ul>
		</div>
		<button class="btn btn-outline-secondary" id="recognition-dic">辞書読込</button>
		<!--<input class="btn-check btn-outline-secondary" type="checkbox" value="" id="recognition-local"><label class="btn btn-outline-secondary" for="recognition-local">プリロールに出力</label>-->
	</div>
	<div class="btn-group m-2">
		<div class="dropdown" id="screen-theme">
			<button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">画面テーマ</button>
			<ul class="dropdown-menu">
			<li class="dropdown-item" data-theme="dark">ダークモード</li>
			<li class="dropdown-item" data-theme="lignt">ライトモード</li>
			</ul>
		</div>
		<div class="dropdown" id="screen-mode">
			<button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">機能選択</button>
			<ul class="dropdown-menu">
			<li class="dropdown-item" data-mode="0">ノートテイク</li>
			<li class="dropdown-item" data-mode="1">見るだけ</li>
			<li class="dropdown-item" data-mode="2">見るだけ字幕</li>
			<li class="dropdown-item" data-mode="3">見るだけプロンプター</li>
			</ul>
		</div>
		<div class="dropdown" id="font-size">
			<button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">文字サイズ</button>
			<ul class="dropdown-menu">
			<li class="dropdown-item" data-fs="fs-1">最大</li>
			<li class="dropdown-item" data-fs="fs-2">大</li>
			<li class="dropdown-item" data-fs="fs-3">中</li>
			<li class="dropdown-item" data-fs="fs-4">小</li>
			<li class="dropdown-item" data-fs="fs-5">最小</li>
			</ul>
		</div>
		<div class="dropdown" id="translate-lang">
			<button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" value="none">翻訳</button>
			<ul class="dropdown-menu">
			<li class="dropdown-item text-bg-primary" data-lang="none">翻訳なし</li>
			<li class="dropdown-item" data-lang="en">English</li>
			<li class="dropdown-item" data-lang="zh-CN">Chinese</li>
			<li class="dropdown-item" data-lang="ko">Korean</li>
			<li class="dropdown-item" data-lang="id">Indonesian</li>
			</ul>
		</div>
	</div>
	<div class="btn-group m-2 taker-extra">
		<input class="btn-check btn-outline-secondary" type="checkbox" id="speech" /><label class="btn btn-outline-secondary text-nowrap" for="speech">しゃべる</label>
	</div>
</div>
</div>
</div>

<div class="modal fade" id="dialog" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
	<div class="modal-body">
		<div class="alert alert-warning text-center">サーバアドレスが複数あります。１つ選んで下さい</div>
		<select class="form-select" id="dialog-select"></select>
	</div>
	<div class="modal-footer"><button type="button" class="btn btn-primary" id="dialog-button-ok">決定</button></div>
</div>
</div>
</div>

<div style="display:none;">
<input id="amivoice-authorization" type="text" />
<input type="file" id="recognition-dic-load" />
</div>

<script src='./tools/jquery-3.6.0/jquery-3.6.0.min.js'></script>
<script src='./tools/bootstrap-5.3.0/js/bootstrap.bundle.min.js'></script>
<script src='./tools/sprintf-1.1.2/sprintf.min.js'></script>
<script type="text/javascript" src="./tools/amivoice.js"></script>
<script type="text/javascript" src="./tools/mic.js"></script>
<script type="text/javascript">
'use strict';

var tekuteku_url = "";
var taker_name = "";
var screen_mode = 0; // 0:標準, 1:見るだけ, 2:字幕表示
var translate_lang_to = 'none';
var auto_scroll_whiteboard = true;
var auto_scroll_pre_roll = true;
var textarea_height = 0;
var translate_text = function(c){ return c.text; }

var socket;
var connected = false;
var host = "";
var id;	// 自分自身の識別子
var dialog;
var whiteboard = [];
var my_text_index = -1;	// -1 : 通常入力, >=0 : 編集した whiteboard の行番号
var my_text_previous = '';
var m_takers = [];
var reset_timer; // 強制消去用タイマー
var minimum_container_height = 0;

var recognizer = null;
var recognition_local = false;
var recognized_text_list = [];

class recognized_text {
	text = "";
	final = false;
	tobe_sent = false;
	id = -1;
	constructor(text,final,i) { this.set(text,final,i); }
	set(text,final,i) {
		this.text = text;
		this.final = final;
		this.id = i;
		this.tobe_sent = ( this.text.length == 0 ? false : true ); // 空行は送信しない
	}
}

function html_encode(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,"&apos;").replace(/\n/g,"<br>"); }
function html_decode(s) { return s.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot/g,'"').replace(/&apos;/g,"'").replace(/<br>/g,"\n"); }

var token = {};	// トークン一覧

async function fetch_token( token_name ) {
	try {
		const response = await fetch(token_name);
		if (!response.ok) { return false; }
		token = await response.json();
		return true;
 	}
	catch (error) { alert('音声認識初期化エラー : '+error); return false; }
}

function recognizer_vosk() {
	var state = 9;	// 0:未認証未接続 / 1:中間状態 / 2:接続中 / 9:エラー
	var vosk_socket = null;
	var mic = new mic_monitor_t('#recognition-control');
	var mic_stream;
	var vosk_url = tekuteku_url.split(/(:[0-9]+|\?)/)[0]+":"+token["vosk"].port;

	function change_state(i) {
		state = i;
		if (recognizer_.on_change_state) { recognizer_.on_change_state(state); };
	}

	function start_() {
		if ( state != 0 ) return;
		change_state(1);
		vosk_socket = new WebSocket(vosk_url);
		vosk_socket.onopen = function(event){
			vosk_socket.send(`{"job":"start","tekuteku_url":"${tekuteku_url}","vosk_model":"${token["vosk"].model}"}`);
			mic_stream = new mic_stream_t(vosk_socket);
			mic_stream.start();
			mic.start();
		};
		vosk_socket.onclose = function(event){ mic.stop(); mic_stream.stop(); change_state(0); };
		vosk_socket.onerror = function(event){ mic.stop(); mic_stream.stop(); change_state(9); };
		vosk_socket.onmessage = function(event) {
			let rc = JSON.parse(event.data);
			if ( rc.code == "ok" ) { change_state(2); } else { mic.stop(); mic_stream.stop(); change_state(9); }
		};
	};

	function stop_() {
		if ( state != 2 ) return;
		mic.stop();
		mic_stream.stop();
		vosk_socket.close();
		change_state(1);
	};

	function status_() { change_state(state); return state; };

	var recognizer_ = {
		start : start_,
		stop : stop_,
		status : status_,
		set_lang : ()=>{ alert('set_lang is not supported'); },
		set_dic : ()=>{ alert('set_dic is not supported'); },
		on_change_state : undefined
	};
	change_state(0);
	return recognizer_;
}

function recognizer_yyprobe() {
	var api_key = token["yyprobe"].key;
	var state = 9;	// 0:未認証未接続 / 1:中間状態 / 2:接続中 / 9:エラー
	var yy_socket = null;
	var mic = new mic_monitor_t('#recognition-control');
	var mic_stream;
	var yy_url = tekuteku_url.split(/(:[0-9]+|\?)/)[0]+":"+token["yyprobe"].port;

	function change_state(i) {
		state = i;
		if (recognizer_.on_change_state) { recognizer_.on_change_state(state); };
	}

	function start_() {
		if ( state != 0 ) return;
		change_state(1);
		yy_socket = new WebSocket(yy_url);
		yy_socket.onopen = function(event){
			yy_socket.send(`{"job":"start","api_key":"${api_key}","tekuteku_url":"${tekuteku_url}"}`);
			mic_stream = new mic_stream_t(yy_socket);
			mic_stream.start();
			mic.start();
		};
		yy_socket.onclose = function(event){ mic.stop(); mic_stream.stop(); change_state(0); };
		yy_socket.onerror = function(event){ mic.stop(); mic_stream.stop(); change_state(9); };
		yy_socket.onmessage = function(event) {
			let rc = JSON.parse(event.data);
			if ( rc.code == "ok" ) { change_state(2); } else { mic.stop(); mic_stream.stop(); change_state(9); }
		};
	};

	function stop_() {
		if ( state != 2 ) return;
		mic.stop();
		mic_stream.stop();
		yy_socket.close();
		change_state(1);
	};

	function status_() { change_state(state); return state; };

	var recognizer_ = {
		start : start_,
		stop : stop_,
		status : status_,
		set_lang : ()=>{ alert('set_lang is not supported'); },
		set_dic : ()=>{ alert('set_dic is not supported'); },
		on_change_state : undefined
	};
	change_state(0);
	return recognizer_;
}

function recognizer_amivoice() {
	var state = 9;	// 0:未認証未接続 / 1:中間状態 / 2:接続中 / 9:エラー
	var recognizer_ = {
		start : start_,
		stop : stop_,
		status : status_,
		set_lang : ()=>{ alert('set_lang is not supported'); },
		set_dic : set_dic_,
		on_change_state : undefined
	};
	var mic = new mic_monitor_t('#recognition-control');

	Wrp.sid = token["amivoice"].username;
	Wrp.spw = token["amivoice"].password;

	Wrp.serverURL = "wss://acp-api.amivoice.com/v1/nolog/";	// ログを残さない場合は /nolog を付加
	Wrp.authorizationElement = document.getElementById('amivoice-authorization');
	Wrp.issuerURL = "https://acp-api.amivoice.com/issue_service_authorization";
	Wrp.profileWords = "";
	Wrp.epi = '60000';
	Wrp.grammarFileNames = '-a2-multi-general';
	Recorder.maxRecordingTime = 0;

	function update_result(result,is_final) {
		let text = html_encode(Result.parse(result).text);
		let a = my_split(text,35,40,'ja-JP');
		let j=0;
		a.forEach((x)=>{
			if ( j >= recognized_text_list.length ) recognized_text_list.push(new recognized_text(x,is_final,j));
			let y = recognized_text_list[j];
			if ( x != y.text || is_final != y.final ) y.set(x,is_final,j);
			j++;
		});
		recognized_text_list.splice(j);
		if ( recognition_local == true ) {
			let s = "";
			recognized_text_list.forEach((c)=>{ s += ( c.text + ( c.final == true ? "\n" : " ...\n" ) ); });
			$('#pre-roll').val(s);
			if ( auto_scroll_pre_roll == true ) $('#pre-roll')[0].scroll({top:$('#pre-roll')[0].scrollHeight,behavior:'instant'});
		}
		else { send(0); }
	};
	function change_state(i) {
		state = i;
		if (recognizer_.on_change_state) { recognizer_.on_change_state(state); };
	};

	Wrp.connectStarted = function(){ change_state(1); };
	Wrp.connectEnded = function(){};
	Wrp.disconnectStarted = function(){ change_state(1); };
	Wrp.disconnectEnded = function(){ change_state(0); };
	Wrp.feedDataResumeStarted = function(){};
	Wrp.feedDataResumeEnded = function(){ change_state(2); };
	Wrp.feedDataPauseStarted = function(){};
	Wrp.feedDataPauseEnded = function(reason){};
	Wrp.utteranceStarted = function(time){};
	Wrp.utteranceEnded = function(time){};
	Wrp.issueStarted = function(){ change_state(1); };
	Wrp.issueEnded = function(){ Wrp.feedDataResume(); };
	Wrp.resultCreated = function(){ recognized_text_list = []; send(2); };
	Wrp.resultUpdated = function(result){ update_result(result,false); };
	Wrp.resultFinalized = function(result){ update_result(result,true); };
	Wrp.eventNotified = function(event_id,event_message){};
	Wrp.TRACE = function(message){};

	function start_(){ if ( state == 0 ) { Wrp.issue(); } mic.start(); };
	function stop_(){ if ( state == 2 ) { Wrp.feedDataPause(); } mic.stop(); };
	function status_(){ change_state(state); return state; };
	function set_dic_(dictionary){ Wrp.profileWords = dictionary.join('|'); };
	change_state(0);
	return recognizer_;
}

function recognizer_default() {
	var state = 9;	// 0:未認証未接続 / 1:中間状態 / 2:接続中 / 9:エラー
	var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;
	var sprec = new SpeechRecognition();
	sprec.continuous = true;
	sprec.interimResults = true;
	sprec.maxAlternatives = 1;
	sprec.lang = 'ja-JP';

	sprec.onresult = function(event){
		let j=0;
		for (let i=0;i<event.results.length;i++) {
			let result = event.results[i];
			if ( result[0].transcript.length == 0 ) continue;
			let a = my_split(result[0].transcript,35,40,sprec.lang);
			a.forEach((x)=>{
				if ( j < recognized_text_list.length ) {
					let y = recognized_text_list[j];
					if ( x != y.text || result.isFinal != y.final ) y.set(x,result.isFinal,j);
				}
				else recognized_text_list.push(new recognized_text(x,result.isFinal,j));
				j++;
			});
		}
		if ( j < recognized_text_list.length ) recognized_text_list.splice(j);
		if ( recognition_local == true ) {
			let s = "";
			recognized_text_list.forEach((c)=>{ s += ( c.text + ( c.final == true ? "\n" : " ...\n" ) ); });
			$('#pre-roll').val(s);
			if ( auto_scroll_pre_roll == true ) $('#pre-roll')[0].scroll({top:$('#pre-roll')[0].scrollHeight,behavior:'instant'});
		}
		send(0);
	}
	sprec.onspeechstart = function(event){ recognized_text_list = []; send(2); }
	sprec.onspeechend = function(event){}
	sprec.onstart = function(){ change_state(2); }
	sprec.onend = function(){ if ( state == 2 ) { sprec.start(); } else { change_state(0); } }
	sprec.onerror = function(event){ sprec.stop(); mic.stop(); change_state(9); }

	var recognizer_ = {
		start : start_,
		stop : stop_,
		status : status_,
		set_lang : set_lang_,
		set_dic : ()=>{ alert('set_dic is not supported'); },
		on_change_state : undefined
	};
	var mic = new mic_monitor_t('#recognition-control');

	function change_state(i) {
		state = i;
		if (recognizer_.on_change_state) { recognizer_.on_change_state(state); };
	};

	function start_() { if ( state == 0 ) { change_state(1); sprec.start(); mic.start(); } };
	function stop_() { if ( state == 2 ) { change_state(1); sprec.stop(); mic.stop(); } };
	function status_(){ change_state(state); return state; };
	function set_lang_(lang){ sprec.lang = lang; if ( state == 2 ) { sprec.stop(); } };
	change_state(0);
	return recognizer_;
}

function recognition_control_update(state) {
	switch (state) {
		case 0: { $('#recognition-control').prop('disabled',false).text('音声認識開始').val(0); break; }
		case 1: { $('#recognition-control').prop('disabled',true).text('お待ち下さい').val(1); break; }
		case 2: { $('#recognition-control').prop('disabled',false).removeClass('btn-outline-warning').addClass('btn-outline-success').text('音声認識停止').val(2); break; }
		case 9: {
			$('#recognition-control').prop('disabled',false).removeClass('btn-outline-success').addClass('btn-outline-warning').text('お待ち下さい').val(9); 
			$('#recognition-engine').trigger('hide.bs.dropdown');
			recognizer.start();
			break;
		}
	}
}

function set_recognition_engine(engine) {
	if (recognizer) { recognizer.stop(); recognizer = null; }
	$('#recognition-lang').hide();
	$('#recognition-dic').hide();
	switch (engine) {
		case "default": {
			recognizer = recognizer_default();
			$('#recognition-lang').show().trigger('hide.bs.dropdown');
			break;
		}
		case "amivoice": {
			recognizer = recognizer_amivoice();
			$('#recognition-dic').show();
			break;
		}
		case "yyprobe": { recognizer = recognizer_yyprobe(); break; }
		case "vosk": { recognizer = recognizer_vosk(); break; }
	}
	recognizer.on_change_state = recognition_control_update;
	recognizer.status();
}

function my_split(s,min_length,max_length,lang) {
	var b = [];
	if ( lang == 'ja-JP' ) {
		// [\u3041-\u3096] : ひらがな（サロゲートペアは除く）
		// [\u3041-\u3096]([\u3400-\u9FFF\uF900-\uFAFF]) : ひらがな＋漢字
		// Chrome の音声認識は文の間に半角スペースが入る。
		//
		for (let x=s;;) {
			if ( x.length <= min_length ) { b.push(x); break; }
			let i = x.substring(min_length,max_length+1).search(/([ .,。、]|[\u3041-\u3096][\u3400-\u9FFF\uF900-\uFAFF])/);
			let j = ( i == -1 ? max_length : min_length+i+1 );
			b.push(x.substring(0,j));
			x = x.substring(j);
		}
	}
	else {
		for (let x=s;;) {
			if ( x.length <= min_length ) { b.push(x); break; }
			let i = x.substring(min_length,max_length+1).search(/[ .,:;]/);
			let j = ( i == -1 ? max_length : min_length+i+1 );
			b.push(x.substring(0,j));
			x = x.substring(j);
		}
	}
	return b;
}

function send( status ) {
	if ( connected == true ) {
		var response = new Object();
		response.status = status;	// 確定入力無(0),確定入力有(1),音声認識セッション開始(2),アプリ共有更新(3),黒板クリア(8),全データ要求(9)
		if ( status != 8 && screen_mode == 0 ) {
			response.text = ( taker_name.length != 0 && my_text_index == -1 ? taker_name+"）" : "" )+$('#my-text').val();
			response.text_index = my_text_index;
			response.voice_text = [];
			if ( recognition_local == false ) {
				for (let i=0;i<recognized_text_list.length;i++) {
					let c = recognized_text_list[i];
					if ( c.tobe_sent == true ) {
						response.voice_text.push({text:c.text,id:c.id,final:c.final});
						c.tobe_sent = false;
					}
				}
				const i = recognized_text_list.findIndex((c)=>!c.final);
				if ( i>0 ) response.voice_fixed = recognized_text_list[i-1].id;
				if ( recognized_text_list.length != 0 ) response.voice_last = recognized_text_list.at(-1).id;
			}
		}
		socket.send(JSON.stringify(response));
//		socket.send(new Blob([JSON.stringify(response)],{type:"application/json",}));
	}
}

const k_success = 'text-success-emphasis bg-success-subtle border border-success-subtle';
const k_warning = 'text-warning-emphasis bg-warning-subtle border border-warning-subtle';

function socket_open(url) {
	if ( connected == true ) { socket_close(); }
	socket = new WebSocket(url);
	$('#host').text('接続中 ...').removeClass(k_success).addClass(k_warning);
	socket.onopen = function(event){ connected = true; send(9); };
	socket.onclose = function(event){ socket_close(); };
	socket.onerror = function(event){} // iphone で background 移行数秒後に発生する。
	socket.onmessage = receive;
	window.clearTimeout(reset_timer);
}

function socket_close() {
	socket.close();
	socket = undefined;
	$('#host').text('サーバとの接続が切断されました。再接続して下さい。').removeClass(k_success).addClass(k_warning);
	connected = false;
	reset_timer = window.setTimeout(()=>{ whiteboard = []; $('#whiteboard-table').empty(); },21600000); // 6 時間 21600 秒で強制消去
}

async function host_select(hosts) {
	let message = 'に接続しました。';
	if ( is_localhost() == true ) {
		if ( hosts === undefined || hosts.length == 0 ) { $('#host').text("ネットワークにつながっていません").removeClass(k_success).addClass(k_warning); return; }
		if ( hosts.length >= 2 ) {
			$('#dialog-select').empty();
			hosts.forEach((c)=>{ $('#dialog-select').append($('<option>').text(c).val(c)); });
			let x = new bootstrap.Modal($('#dialog').get(0),{});
			let dialog = new Promise((resolve)=>{
				$('#dialog-button-ok').one('click',()=>{
					host=$('#dialog-select > option:selected').val();
					x.hide();
				});
				$('#dialog')
					.off('hidden.bs.modal')
					.one('hidden.bs.modal',()=>{ resolve(); x.dispose(); });
				x.show();
			});
			const result = await dialog;
		}
		else { host = hosts[0]; }
		message += 'このアドレスを他の人に通知して下さい。';
	}
	$('#host').text(host+message).removeClass(k_warning).addClass(k_success);
}

function update_table_takers() {
	let f = function(i,s){ return sprintf('<tr><td class="text-center" style="width:3ch;">%d</td><td class="teku">%s</td></tr>',i,s); };
	if ( is_small_screen() ) f = function(i,s){ return sprintf('<tr><td class="teku">%s</td></tr>',s); };
	let num_ro = 0;
	$('#table-takers > tbody').empty();
	m_takers.forEach((c)=>{
		if ( c.id == id || 'text' in c == false ) return;
		let s = ( c.text.length == 0 ? '　' : c.text.replace(/\n/g,'<br>') ); // 空文字で行がつぶれない様に全角スペースを入れる
		$('#table-takers > tbody').append(f(c.num,s));
	});
	if ( !is_small_screen() && num_ro ) $('#table-takers > tbody').append(sprintf('<tr><td class="text-center" style="width:3ch;">見</td><td>%d人</td></tr>',num_ro));
}

async function receive(event) {
//	var response = JSON.parse( await event.data.text() ); // for binary
	var response = JSON.parse(event.data);
	switch ( response.type ) {
	case 0 :
		id = response.id;
		host_select(response.server);
		break;
	case 1 :
		response.whiteboard.forEach((c)=>{ whiteboard[c.i] = c; });
		whiteboard.splice(response.whiteboard_size);
		if ( response.whiteboard_size == 0 ) { $('#whiteboard-table').empty(); }
		let t = $('#whiteboard-table > tr > td');
		t.slice(response.whiteboard_size).text('').attr('name','-').removeClass('text-warning'); // whiteboard-table は縮小せず空白に。
		response.whiteboard.forEach((c)=>{
			let o = whiteboard[c.i];
			let s = html_encode(translate_text(o));
			if ( o.i < t.length ) {
				let x = t.eq(o.i);
				x.attr('name',o.i).html(s);
				if ( o.edit == 1 ) { x.addClass('text-warning'); } else { x.removeClass('text-warning'); }
			}
			else { $('#whiteboard-table').append(sprintf('<tr><td name="%d" %s>%s</td></tr>',o.i,( o.edit == 1 ? 'class="text-warning"' : '' ),s)); }
		});
		if ( auto_scroll_whiteboard == true ) $('#whiteboard-div')[0].scroll({top:$('#whiteboard-div')[0].scrollHeight,behavior:'instant'});
		m_takers = response.takers.sort((x,y)=>{ return (( 'text' in x ? x.num : -1 )-( 'text' in y ? y.num : -1 )); }).concat();
		update_table_takers();
		break;
	}
}

function is_localhost() { return ( location.hostname == 'localhost' || location.hostname == '127.0.0.1' ); }
function use_voice_recognition() { return ( location.hostname == 'localhost' || location.hostname == '127.0.0.1' || location.protocol == 'https:' ); }

function append_input( s ) {
	var o = $('#my-text').get(0);
	var pos = $(o).prop('selectionStart');
	var a = $(o).val();
	$('#my-text').val( a.substring(0,pos)+s+a.substring(pos,a.length) );
}

function mk_guide() {
	let o = $('#my-text');
	let f = parseInt(o.css('font-size'));
	let w = parseInt(o.css('width'));
	let h = parseInt(o.css('height'));
	let x = `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w-1} ${h-1}"><line x1="${f*24}" y1="1" x2="${f*24}" y2="${h-2}" stroke="white" stroke-dasharray="4" stroke-width="1"></line></svg>`;
	return 'url(\'data:image/svg+xml;charset=utf8,'+encodeURIComponent(x)+'\')';
}

function get_current_line() {
	// pre-roll の現在行の文字列を取得する。
	let o = $('#pre-roll').get(0);
	let s = $(o).val();
	let pos = $(o).prop('selectionStart');
	let i0 = ( pos == 0 ? 0 : s.lastIndexOf('\n',( s.charAt(pos) == '\n' ? pos-1 : pos ))+1 );
	let i1 = s.indexOf("\n",pos);
	return ( i1 == -1 ? s.substring(i0) : s.substring(i0,i1) );
}

function set_font_size( font_size ) {
	if ( /^fs-[1-5]$/.test(font_size) == false ) { return; }
	$('.fs-taker').removeClass('fs-1 fs-2 fs-3 fs-4 fs-5').addClass(( font_size != 'fs-5' ? 'fs-4' : 'fs-5' ));
	$('#whiteboard-table').removeClass('fs-1 fs-2 fs-3 fs-4 fs-5').addClass(font_size);
	$('#font-size li').removeClass('text-bg-primary').filter(sprintf('[data-fs="%s"]',font_size)).addClass('text-bg-primary');
	set_screen_mode();
	$('#my-text').on('keyup change',function(){ $(this).css('background-image',( $(this).val().length == 0 ? '' : mk_guide() )); });
}

function set_theme(theme) {
	document.documentElement.setAttribute('data-bs-theme',theme);
	$('#screen-theme li').removeClass('text-bg-primary').filter(sprintf('[data-theme="%s"]',theme)).addClass('text-bg-primary');
}

function eval_minimum_container_height() {
	let o = $('div.container-fluid > div.row > div.col:nth-child(2) > div:visible').last().get(0);
	if ( o !== undefined ) minimum_container_height = Math.ceil(o.getBoundingClientRect().bottom+$('div.container-fluid > div.row:last-child').height())+10;
}

function is_small_screen(axis) {
	if ( axis == 'h' ) return ( window.visualViewport.height < minimum_container_height );
	return ( $(window).width() < 768 );
}

function set_screen_mode(mode) {
	eval_minimum_container_height();
	if ( mode != null ) {
		screen_mode = mode;
		$('#screen-mode li').removeClass('text-bg-primary').filter(sprintf('[data-mode="%d"]',screen_mode)).addClass('text-bg-primary');
	}
	$('div.container-fluid div.row:first-child').css('transform','');
	const o = $('div.container-fluid > div.row:first-child > div.col:first-child');
	if ( screen_mode != 0 || is_small_screen() ) { o.removeClass('col-10').addClass('col-12'); } else { o.removeClass('col-12').addClass('col-10'); }

	switch(screen_mode) {
	case 0:
		$('.taker').show();
		if ( use_voice_recognition() ) { $('.taker-voice-recognition').show(); } else { $('.taker-voice-recognition').hide(); }
		if ( is_small_screen() ) { $('.taker-extra').hide(); } else { $('.taker-extra').show(); }
		$('#my-text').attr('placeholder',( is_small_screen() ? "ここでテキスト入力" : "ここでテキスト入力。'ENTER'で送信。'SHIFT+ENTER'で改行。'ESC'で全消去。"));
		break;
	case 3:
		$('div.container-fluid div.row:first-child').css('transform','scale(1,-1)');
	case 1:
	case 2:
		$('.taker,.taker-voice-recognition,.taker-extra').hide();
		if ( is_small_screen() == false ) { $('#host').show(); }
		set_theme('dark');
		break;
	}

	const height = window.innerHeight;
	const minimum_whiteboard_height = 200;
	let height_container = $('div.container-fluid').height();
	let height_delta = Math.floor(height-height_container);
	let height_menu = $('div.container-fluid > div.row:last-child').height();
	let height_whiteboard = $('#whiteboard-div').height()+height_delta;
	if ( is_small_screen('h') == true ) height_whiteboard += height_menu;
	if ( height_whiteboard < minimum_whiteboard_height ) height_whiteboard = minimum_whiteboard_height;
	$('#whiteboard-exclude').hide();
	if ( screen_mode == 2 && height_whiteboard > minimum_whiteboard_height ) {
		$('#whiteboard-exclude').css('height',(height_whiteboard-minimum_whiteboard_height)+'px').show();
		height_whiteboard = minimum_whiteboard_height;
	}
	$('#whiteboard-div').height(height_whiteboard);
	if ( auto_scroll_whiteboard == true ) $('#whiteboard-div')[0].scroll({top:$('#whiteboard-div')[0].scrollHeight,behavior:'instant'});
}

function shortcut_from_cookie() {
	document.cookie.replace(/ /g,'').split(';').forEach((a)=>{
		let c = a.split('=');
		let key = c[0];
		let val = decodeURI(c[1]);
		switch (key) {
			case 'F1' : $('#key-1').val(val); break;
			case 'F2' : $('#key-2').val(val); break;
			case 'F3' : $('#key-3').val(val); break;
			case 'F4' : $('#key-4').val(val); break;
			case 'F5' : $('#key-5').val(val); break;
			case 'F6' : $('#key-6').val(val); break;
			case 'F7' : $('#key-7').val(val); break;
			case 'F8' : $('#key-8').val(val); break;
			case 'F9' : $('#key-9').val(val); break;
			case 'screen-theme' : set_theme(val); break;
			case 'screen-mode' : set_screen_mode(parseInt(val)); break;
			case 'font-size' : set_font_size(val); break;
		}
	});
}

function shortcut_to_cookie() {
	document.cookie = 'F1='+encodeURI($('#key-1').val());
	document.cookie = 'F2='+encodeURI($('#key-2').val());
	document.cookie = 'F3='+encodeURI($('#key-3').val());
	document.cookie = 'F4='+encodeURI($('#key-4').val());
	document.cookie = 'F5='+encodeURI($('#key-5').val());
	document.cookie = 'F6='+encodeURI($('#key-6').val());
	document.cookie = 'F7='+encodeURI($('#key-7').val());
	document.cookie = 'F8='+encodeURI($('#key-8').val());
	document.cookie = 'F9='+encodeURI($('#key-9').val());
	document.cookie = 'screen-theme='+encodeURI(document.documentElement.getAttribute('data-bs-theme').toString());
	document.cookie = 'screen-mode='+encodeURI(screen_mode.toString());
	document.cookie = 'font-size='+encodeURI($('#font-size li').filter('.text-bg-primary').data('fs'));
}

function scroll_input() {
	// テキスト入力欄 (#my-text) が画面下部になる様にスクロール
	window.scroll({top:$('div.container-fluid > div.row:last-child').offset().top-window.visualViewport.height,behavior:'instant'});
}

set_font_size('fs-4');
set_theme('dark');
set_screen_mode(0); scroll_input();
shortcut_from_cookie();
textarea_height = $('#my-text').height();

const resize_observer = new ResizeObserver((entries)=>{ set_screen_mode(); });
$('div.container-fluid,#my-text,#pre-roll,#table-takers').each((i,e)=>{resize_observer.observe(e);}); // body を加えると resize event が頻発する。
$(window).on("load orientationchange",()=>{ set_screen_mode(); });
$(window).on('beforeunload pagehide',function(){ shortcut_to_cookie(); socket_close(); });
$('#whiteboard-div').on('scroll',function(event){ auto_scroll_whiteboard = ( this.scrollHeight-this.scrollTop-this.clientHeight < 10 ? true:false ); });
$('#pre-roll').on('scroll',function(event){ auto_scroll_pre_roll = ( this.scrollHeight-this.scrollTop-this.clienttHeight < 10 ? true:false ); });
$('#clear').on('click',function(){ if ( confirm('テイクを消去してよい？') == true ) { send(8); } });
$('#taker-name').on('change',function(){ taker_name = $(this).val(); });
$('#screen-theme').on('hide.bs.dropdown',({clickEvent})=>{ if ( clickEvent?.target && $(clickEvent.target).hasClass('dropdown-item') ) { set_theme($(clickEvent.target).data('theme')); } });
$('#screen-mode').on('hide.bs.dropdown',({clickEvent})=>{
	if ( clickEvent?.target && $(clickEvent.target).hasClass('dropdown-item') ) {
		set_screen_mode(parseInt($(clickEvent.target).data('mode')));
		send(0);
	}
});
$('#font-size').on('hide.bs.dropdown',({clickEvent})=>{ if ( clickEvent?.target && $(clickEvent.target).hasClass('dropdown-item') ) { set_font_size($(clickEvent.target).data('fs')); } });
$('#translate-lang').on('hide.bs.dropdown',({clickEvent})=>{
	if ( clickEvent?.target && $(clickEvent.target).hasClass('dropdown-item') ) {
		$('#translate-lang li.text-bg-primary').removeClass('text-bg-primary');
		let lang = $(clickEvent.target).addClass('text-bg-primary').data('lang');
		if ( lang != translate_lang_to ) {
			translate_lang_to = lang;
			let t = $('#whiteboard-table > tr > td');
			whiteboard.forEach((c)=>{
				let s = html_encode(translate_text(c));
				if ( c.i < t.length ) { t.eq(c.i).attr('name',c.i).html(s); }
			});
		}
	}
});

$('#recognition-dic').on('click',function(){ $('#recognition-dic-load').click(); });
$('#recognition-dic-load').on('change',function(){
	if ( this.files.length == 1 ) {
		let blob = this.files[0];
		let reader = new FileReader();
		reader.onload = function(){
			let dic = [];
			reader.result.split(/\r*\n/).forEach(a=>{
				var c = a.split(/\s+/);
				if ( c[0].length != 0 && c[1].length != 0 ) { dic.push(c[0]+' '+c[1]); }
			});
			recognizer.set_dic(dic);
			$('#recognition-dic-load').val('');
			$('#recognition-dic').blur();
		};
		reader.readAsText(blob);
	}
});
$('#recognition-control').on('click',function(event){
	let x = $('#recognition-engine li').filter('.text-bg-primary').data('engine');
	switch ( $('#recognition-control').val() ) {
		case '0' : { recognizer.start(); break; }
		case '2' : { recognizer.stop(); break; }
		case '9' : { $('#recognition-engine').trigger('hide.bs.dropdown'); break; }
	}
});
$('#recognition-engine').on('hide.bs.dropdown',({clickEvent})=>{
	if ( clickEvent?.target && $(clickEvent.target).hasClass('dropdown-item') ) {
		$('#recognition-engine li.text-bg-primary').removeClass('text-bg-primary');
		$(clickEvent.target).addClass('text-bg-primary');
	}
	let x = $('#recognition-engine li').filter('.text-bg-primary');
	set_recognition_engine(x.data('engine'));
	$('#recognition-engine button').text(x.text());
});
$('#recognition-lang').on('hide.bs.dropdown',({clickEvent})=>{
	if ( clickEvent?.target && $(clickEvent.target).hasClass('dropdown-item') ) {
		$('#recognition-lang li.text-bg-primary').removeClass('text-bg-primary');
		let x = $(clickEvent.target).addClass('text-bg-primary');
		recognizer.set_lang(x.data('lang'));
		$('#recognition-lang button').text(x.text());
	}
});
// $('#recognition-local').on('change',function(event){ recognition_local = $('#recognition-local').is(':checked'); });

$('#my-text')
	.on('focusin blur',function(event){ window.setTimeout(scroll_input,200); })
	.on('input',function(event){
		let o = $('#my-text')[0];
		if ( o.scrollHeight > o.clientHeight ) { $(o).height(textarea_height*Math.trunc(o.scrollHeight/textarea_height)); }
		send(0);
	});

$('#whiteboard-div').on('click','#whiteboard-table tr td',function(event){
	if ( event.button == 0 ) {
		if ( my_text_index != -1 ) {
			$('#my-text').val(my_text_previous);
			send(1);
			my_text_previous = '';
			$('#my-text').val('').height(textarea_height);
		}
		my_text_index = parseInt($(this).attr('name'));
		my_text_previous = html_decode($(this).html());
		$('#my-text').val(my_text_previous).focus().trigger('input');
	}
});

$('#pre-roll').on('dblclick',function(event){
	if ( event.button == 0 ) {
		$('#my-text').val(get_current_line()).focus().trigger('input');
	}
});

$(document).on('keydown',function(event){
	if ( event.target == $('#pre-roll').get(0) ) {
		switch ( event.key ) {
		case 'F1' :
			event.preventDefault();
			$('#my-text').val(get_current_line()); send(1); $('#my-text').val('');
			break;
		case 'Escape' :
			event.preventDefault();
			$('#pre-roll').val('');
			break;
		}
	}
	else if ( event.target == $('#my-text')[0] ) {
		switch ( event.key ) {
		case 'Enter' :
			if ( event.shiftKey ) {
				var num = $('#my-text').val().split('\n').length+1;
				$('#my-text').prop('rows',num);
			}
			else {
				event.preventDefault();
				send(1);
				if ( $('#speech').is(':checked') == true ) {
					const uttr = new SpeechSynthesisUtterance()
					uttr.text = $('#my-text').val();
					speechSynthesis.speak(uttr);
				}
				$('#my-text').val('').prop('rows',1).height(textarea_height);
				my_text_index = -1;
				my_text_previous = '';
			}
			break;
		case 'Escape' :
			event.preventDefault();
			if ( my_text_index != -1 ) {
				$('#my-text').val(my_text_previous);
				send(1);
				my_text_previous = '';
			}
			$('#my-text').val('').height(textarea_height);
			my_text_index = -1;
			break;
		}
	}
	switch ( event.key ) {
		case 'F1' : event.preventDefault(); append_input($('#key-1').val()); break;
		case 'F2' : event.preventDefault(); append_input($('#key-2').val()); break;
		case 'F3' : event.preventDefault(); append_input($('#key-3').val()); break;
		case 'F4' : event.preventDefault(); append_input($('#key-4').val()); break;
		case 'F5' : event.preventDefault(); append_input($('#key-5').val()); break;
		case 'F6' : event.preventDefault(); append_input($('#key-6').val()); break;
		case 'F7' : event.preventDefault(); append_input($('#key-7').val()); break;
		case 'F8' : event.preventDefault(); append_input($('#key-8').val()); break;
		case 'F9' : event.preventDefault(); append_input($('#key-9').val()); break;
	}
});

async function save_shortcut() {
	let a = [];
	a.push(`F1 ${$('#key-1').val()}\n`);
	a.push(`F2 ${$('#key-2').val()}\n`);
	a.push(`F3 ${$('#key-3').val()}\n`);
	a.push(`F4 ${$('#key-4').val()}\n`);
	a.push(`F5 ${$('#key-5').val()}\n`);
	a.push(`F6 ${$('#key-6').val()}\n`);
	a.push(`F7 ${$('#key-7').val()}\n`);
	a.push(`F8 ${$('#key-8').val()}\n`);
	a.push(`F9 ${$('#key-9').val()}\n`);
	const b = new Blob(a,{type:'text/plain'});
	const f = await window.showSaveFilePicker({suggestedName:'shortcut.txt'});	// ファイル保存ダイアログを表示して FileSystemFileHandle オブジェクトを取得
	const s = await f.createWritable();	// FileSystemWritableFileStream オブジェクトを取得
	await s.write(b);	// テキストデータをファイルに書き込む
	await s.close();	// ファイルを閉じる
}

$('#shortcut-load-file').on('change',function(){
	if ( this.files.length == 1 ) {
		var blob = this.files[0];
		var reader = new FileReader();
		reader.readAsText(blob);
		reader.onload = function(){
			reader.result.split(/\r*\n/).forEach(a=>{
				var c = a.split(/\s/);
				switch (c[0]) {
					case 'F1' : $('#key-1').val(c[1]); break;
					case 'F2' : $('#key-2').val(c[1]); break;
					case 'F3' : $('#key-3').val(c[1]); break;
					case 'F4' : $('#key-4').val(c[1]); break;
					case 'F5' : $('#key-5').val(c[1]); break;
					case 'F6' : $('#key-6').val(c[1]); break;
					case 'F7' : $('#key-7').val(c[1]); break;
					case 'F8' : $('#key-8').val(c[1]); break;
					case 'F9' : $('#key-9').val(c[1]); break;
				}
			});
			$('#shortcut-load-file').val('');
		};
	}
});

$('#shortcut').on('hide.bs.dropdown',({clickEvent})=>{
	if ( clickEvent?.target && $(clickEvent.target).hasClass('dropdown-item') ) {
		let job = $(clickEvent.target).data('job');
		if ( job == 'load' ) { $('#shortcut-load-file').click(); }
		if ( job == 'save') { save_shortcut(); }
	}
});

$('#translate-lang').hide();
$('#recognition-engine').hide();

fetch_token('./config.json').then((ok)=>{
	if (ok) {
		let n = 0;
		if ( 'yyprobe' in token ) { $('#recognition-engine > ul.dropdown-menu').append('<li class="dropdown-item" data-engine="yyprobe">YYProbe</li>'); n++; }
		if ( 'amivoice' in token ) { $('#recognition-engine > ul.dropdown-menu').append('<li class="dropdown-item" data-engine="amivoice">AmiVoice</li>'); n++; }
		if ( 'vosk' in token ) { $('#recognition-engine > ul.dropdown-menu').append('<li class="dropdown-item" data-engine="vosk">VOSK</li>'); n++; }
		if ( n != 0 ) $('#recognition-engine').show();
		if ( 'google-translate' in token ) {
			translate_text = function(c) { // c : whiteboard の要素 ( i,text,edit )
				let api_key = token['google-translate'].key;
				if ( translate_lang_to == 'none' ) { return c.text; }
				if (!( translate_lang_to in c )) {
					$.ajax(
						"https://translation.googleapis.com/language/translate/v2?key="+api_key+"&q="+encodeURI(c.text)+"&source=ja&target="+translate_lang_to,
						{type:'post',dataType:'json',async:false})
						.done((result)=>{ c[translate_lang_to] = decodeURI(result.data.translations[0].translatedText); })
						.fail(()=>{ alert("error in google-translate"); });
				}
				return c[translate_lang_to];
			};
			$('#translate-lang').show();
		}
	}
});

if ( use_voice_recognition() == true ) { $('#recognition-engine').trigger('hide.bs.dropdown'); }
$('#pi-control').hide();
switch (location.protocol) {
	case 'https:':
		host = location.host;
		tekuteku_url = "wss://"+location.host+location.search;
		$('#clear').parent().show();
		fetch('./pi.html').then((r)=>{ if ( r.status == 200 ) { $('#pi-control').show(); } });
		break;
	case 'http:':
		host = location.host;
		tekuteku_url = "ws://"+location.host+location.search;
		$('#clear').parent().hide();
		break;
	default:
		alert("間違った操作です");
		$('#clear').parent().hide();
		break;
}
if ( tekuteku_url.length != 0 ) socket_open(tekuteku_url);

</script>
</body>
</html>
