<!doctype html>
<html lang="ja" data-bs-theme="dark">
<head>
<meta charset="utf-8">
<title>ラズパイコントロール 2025-11-14</title>
<link href='./tools/bootstrap-5.3.0/css/bootstrap.min.css' rel='stylesheet'>
<meta name='viewport' content='width=device-width,initial-scale=1,shrink-to-fit=no'>
</head>
<body>
<div class="container" style="width:400px;">
<div class="col">
	<table class="table table-sm table-bordered bg-secondary text-white caption-top" id="connection-table">
	<caption class="text-center text-white m-2 fs-3 fw-bold">ネットワークの状態</caption>
	<tbody></tbody>
	</table>
	<div class="btn-toolbar justify-content-center m-2">
		<button class="btn btn-outline-success mx-1" id="pi-rescan">リスト更新</button>
		<button class="btn btn-outline-warning mx-1" id="pi-shutdown">ラズパイ終了</button>
		<button class="btn btn-outline-danger mx-1" id="pi-update">ラズパイ更新</button>
	</div>
	<div class="alert alert-dark m-2 mx-auto text-center">WiFiの接続先を変えると<br>ネットワークが切断されることがあります。<br>その時は再接続して下さい。</div>
	<div class="input-group justify-content-center m-2">
		<div class="input-group-text mx-1">AUEWSで使うアカウントの</div>
		<button class="btn btn-outline-secondary mx-1" id="pi-set-auews">更新</button>
		<button class="btn btn-outline-secondary" id="pi-remove-auews">削除</button>
	</div>
	<div class="input-group justify-content-center m-2">
		<a class="btn btn-outline-secondary" href="./ssl-keys/tekuteku-pi.crt">ラズパイ証明書ダウンロード</a> <!-- download を指定すると boost::beast::http::error::end_of_stream となる -->
	</div>
</div>
</div>

<div class="modal fade" id="dialog" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
	<div class="modal-body">
		<div class="text-center fs-5">AUEWSへの接続に使うアカウントを入力してください</div>
		<div class="input-group m-2">
			<input type="text" class="form-control mx-1" placeholder="ユーザー名" id="dialog-username">
			<input type="password" class="form-control mx-1" placeholder="パスワード" id="dialog-password">
		</div>
		<div class="input-group justify-content-end">
			<button type="button" class="btn btn-primary mx-1" id="dialog-button-ok">決定</button>
			<button type="button" class="btn btn-primary mx-1"  data-bs-dismiss="modal">取消</button>
		</div>
	</div>
</div>
</div>
</div>

<div class="modal fade" id="block" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header justify-content-center">
	<div class="text-center fs-3">お待ち下さい<span class="spinner-border ms-2" role="status" aria-hidden="true"></span></div>
</div>
</div>
</div>
</div>

<script src='./tools/jquery-3.6.0/jquery-3.6.0.min.js'></script>
<script src='./tools/bootstrap-5.3.0/js/bootstrap.bundle.min.js'></script>
<script src='./tools/sprintf-1.1.2/sprintf.min.js'></script>
<script type="text/javascript">
'use strict';

class blocker_t {
	id;
	modal;
	constructor(id) {
		this.id = id;
		this.modal = new bootstrap.Modal($(id).get(0),{});
		$(this.id).off('hidden.bs.modal').one('hidden.bs.modal',()=>{ this.modal.dispose(); this.modal = null; });
		this.modal.show();
	}
	free() { setTimeout(()=>{ this.modal.hide(); },500); } // hide() を遅延させないと hidden.bs.modal が補足できない場合がある。
}

function dialog_auews() {
	let x = new bootstrap.Modal($('#dialog').get(0),{});
	let d = new Promise((resolve)=>{
		let username = '';
		let password = '';
		$('#dialog-button-ok').one('click',()=>{
			username = $('#dialog-username').val(); $('#dialog-username').val('');
			password = $('#dialog-password').val(); $('#dialog-password').val('');
			resolve({username,password});
			x.hide();
		});
		$('#dialog').off('hidden.bs.modal').one('hidden.bs.modal',()=>{ x.dispose(); });
		x.show();
	});
	return d;
}

function update_table(data) {
	const cc = 'class="text-info"';
	const b0 = 'class="btn btn-sm w-100 btn-outline-light pi-connect"';
	const b1 = 'class="btn btn-sm w-100 btn-outline-info pi-disconnect"';
	const b2 = 'class="btn btn-sm w-100 btn-outline-light"';

	let connection = data.connections;
	let s = "";
	connection.forEach((c,i)=>{
		switch(c.kind) {
			case 'wifi':
				switch(c.status) {
					case 0: s += `<tr><td>${c.name}</td><td></td><td><button ${b0} value="${c.name}">接続する</button></td></tr>`; break;
					case 1: s += `<tr><td ${cc}>${c.name}</td><td ${cc}>${c.addr}</td><td><button ${b1} value="${c.name}">切断する</button></td></tr>`; break;
					default: s += `<tr><td>${c.name}</td><td></td><td><button ${b2} value="${c.name}" disabled>利用不可</button></td></tr>`; break;
				}
				break;
			default:
				switch(c.status) {
					case 0: s += `<tr><td>${c.name}</td><td></td><td><button ${b0} value="${c.name}" disabled>　　　　</button></td></tr>`; break;
					case 1: s += `<tr><td ${cc}>${c.name}</td><td ${cc}>${c.addr}</td><td><button ${b1} value="${c.name}" disabled>　　　　</button></td></tr>`; break;
					default: s += `<tr><td>${c.name}</td><td></td><td><button ${b2} value="${c.name}" disabled>利用不可</button></td></tr>`; break;
				}
				break;
		}
	});
	$('#connection-table > tbody').empty().append(s);
}

let html_shutdown = `
<div class="container" style="width:400px;">
	<div class="alert alert-warning">
		<div class="text-center fs-3">シャットダウン開始しました。</div>
		<div class="text-center">緑LEDが完全に消灯したらシャットダウン完了です。</div>
		<div class="text-center">このウインドウは閉じて下さい。</div>
	</div>
</div>`;

$(document).ready( function(){
	let x = new blocker_t('#block');
	$.ajax("./pi-control.sh?job=status",{method:'get',async:true,dataType:'json'})
		.done((r)=>{
			if ( r.status == 0 ) alert(r.message);
			update_table(r);
		})
		.fail(()=>{ alert("通信エラー"); })
		.always(()=>{ x.free(); })

	$('#connection-table').on('click','button.pi-connect',function(){
		let ssid = $(this).val();
		$(this).text('接続中');
		let x = new blocker_t('#block');
		$.ajax("./pi-control.sh?job=connect&ssid="+ssid,{method:'get',async:true,dataType:'json'})
			.done((r)=>{ if ( r.status == 0 ) alert(r.message); })
			.fail(()=>{ alert("通信エラー"); })
			.always(()=>{ location.reload(); x.free(); });
	});
	$('#connection-table').on('click','button.pi-disconnect',function(){
		let ssid = $(this).val();
		$(this).text('切断中');
		let x = new blocker_t('#block');
		$.ajax("./pi-control.sh?job=disconnect&ssid="+ssid,{method:'get',async:true,dataType:'json'})
			.done((r)=>{ if ( r.status == 0 ) alert(r.message); })
			.fail(()=>{ alert("通信エラー"); })
			.always(()=>{ location.reload(); x.free(); });
	});
	$('button#pi-rescan').on('click',function(){
		$('#connection-table > tbody').empty();
		let x = new blocker_t('#block');
		$.ajax("./pi-control.sh?job=rescan",{method:'get',async:true,dataType:'json'})
			.done((r)=>{ if ( r.status == 0 ) { alert(r.message); } else { update_table(r); } } )
			.fail(()=>{ alert("通信エラー"); })
			.always(()=>{ x.free(); })
	});
	$('button#pi-shutdown').on('click',function(){
		if ( window.confirm('ラズパイをシャットダウンして良いですか？') == true ) {
			$.ajax("./pi-control.sh?job=shutdown",{method:'get',async:true,dataType:'json'})
				.done(()=>{ $('body').empty().html(html_shutdown); })
				.fail(()=>{ alert("通信エラー"); })
		}
	});
	$('button#pi-update').on('click',function(){
		if ( window.confirm('ラズパイ更新には時間がかかります。始めて良いですか？') == true ) {
			let x = new blocker_t('#block');
			$.ajax("./pi-control.sh?job=update",{method:'get',async:true,dataType:'json'})
				.done((r)=>{ if ( r.status == 0 ) alert(r.message); })
				.fail(()=>{ alert("通信エラー"); })
				.always(()=>{ x.free(); });
		}
	});
	$('button#pi-set-auews').on('click',function(){
		dialog_auews().then((r)=>{
			let username = r.username;
			let password = r.password;
			let x = new blocker_t('#block');
			$.ajax(`./pi-control.sh?job=wpa2-enterprise&ssid=AUEWS&username=${username}&password=${password}`,{method:'get',async:true,dataType:'json'})
				.done((r)=>{ if ( r.status == 0 ) alert(r.message); })
				.fail(()=>{ alert("通信エラー"); })
				.always(()=>{x.free(); })
		});
	});
	$('button#pi-remove-auews').on('click',function(){
		let x = new blocker_t('#block');
		$.ajax("./pi-control.sh?job=wpa2-enterprise&ssid=AUEWS",{method:'get',async:true,dataType:'json'})
			.done((r)=>{ if ( r.status == 0 ) alert(r.message); })
			.fail(()=>{ alert("通信エラー"); })
			.always(()=>{ x.free(); });
	});
});
</script>
</body>
</html>
